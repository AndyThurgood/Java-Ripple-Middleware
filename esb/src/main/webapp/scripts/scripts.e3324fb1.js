"use strict";angular.module("openehrPocApp",["ngResource","ngTouch","ngSanitize","ngAnimate","ui.router","ui.bootstrap","angular-loading-bar","growlNotifications"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/patients"),a.state("patients-list",{url:"/patients",views:{actions:{templateUrl:"views/patients/patients-list-sidebar.html"},main:{templateUrl:"views/patients/patients-list.html",controller:"PatientsListCtrl"}}}).state("patients-charts",{url:"/patients/charts",views:{actions:{templateUrl:"views/patients/patients-list-sidebar.html"},main:{templateUrl:"views/patients/patients-charts.html",controller:"PatientsChartsCtrl"}}}).state("diagnoses-list",{url:"/patients/:patientId/diagnoses",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/diagnoses/diagnoses-list.html",controller:"DiagnosesListCtrl"}}}).state("diagnoses-detail",{url:"/patients/:patientId/diagnoses/:diagnosisId",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/diagnoses/diagnoses-list.html",controller:"DiagnosesListCtrl"},detail:{templateUrl:"views/diagnoses/diagnoses-detail.html",controller:"DiagnosesDetailCtrl"}}})}]).config(["datepickerConfig","datepickerPopupConfig","cfpLoadingBarProvider",function(a,b,c){a.startingDay=1,b.showButtonBar=!1,b.datepickerPopup="dd-MMM-yyyy",c.includeSpinner=!1}]).directive("morrisBar",function(){return{restrict:"E",template:"<div></div>",replace:!0,scope:{data:"=",xkey:"=",ykeys:"=",config:"="},link:function(a,b){var c={element:b,data:a.data,xkey:a.xkey,ykeys:a.ykeys};_.extend(c,a.config),new window.Morris.Bar(c)}}}),angular.module("openehrPocApp").factory("Patient",function(){var a=[{id:746}],b={title:"Mr",firstname:"John",lastname:"Smith",address:"40 High Street, Leeds, West Yorkshire, LS11 2AB",phone:"01876876228",born:"1950-11-01T00:00:00+00:00",gender:"Male",nhsNo:9999999468,gpDetails:"SMITH, Doc (Mrs)",pasNo:1238446};angular.forEach(a,function(a){angular.extend(a,b)});var c=function(){return a},d=function(b){var c=_.findWhere(a,{id:parseInt(b)});return c.fullname=function(){return c.lastname.toUpperCase()+", "+c.firstname+(c.title?" ("+c.title+")":"")},c},e=function(a,b){var c=_.findWhere(a.diagnoses,{id:b.id});angular.extend(c,b)};return{all:c,get:d,update:e}}),angular.module("openehrPocApp").factory("Diagnosis",["$http","$q",function(a,b){var c=function(c){var d=b.defer();return a.get("/openEHR/api/patients/"+c+"/diagnoses").success(function(a){d.resolve(a)}),d.promise},d=function(c,d){var e=b.defer();return a.get("/openEHR/api/patients/"+c+"/diagnoses/"+d).success(function(a){e.resolve(a)}),e.promise},e=function(b,c){return a.put("/openEHR/api/patients/"+b+"/diagnoses/"+c.id,c)},f=function(b,c){return c.patientId=b,a.post("/openEHR/api/patients/"+b+"/diagnoses",c)};return{byPatient:c,findByPatient:d,updateByPatient:e,createByPatient:f}}]),angular.module("openehrPocApp").controller("MainCtrl",function(){}),angular.module("openehrPocApp").controller("PatientsListCtrl",["$scope","$location","Patient",function(a,b,c){a.patients=c.all(),a.go=function(a){b.path(a)}}]),angular.module("openehrPocApp").controller("PatientsChartsCtrl",["$scope","Patient",function(a,b){a.patients=b.all(),a.age={ykeys:["value"],xkey:"age",data:[{age:"0-10",value:5},{age:"11-18",value:1},{age:"19-30",value:1},{age:"31-60",value:7},{age:"61-80",value:2},{age:">80",value:6}],config:{labels:["Patients"],hideHover:!0}},a.department={ykeys:["value"],xkey:"age",data:[{age:"All",value:10},{age:"Emergency",value:1},{age:"Inpatient",value:5},{age:"Outpatient",value:4}],config:{labels:["Patients"],hideHover:!0,barColors:["#0BA462"]}}}]),angular.module("openehrPocApp").controller("PatientsDetailCtrl",["$scope","$stateParams","$location","Patient",function(a,b,c,d){a.patient=d.get(b.patientId)}]),angular.module("openehrPocApp").controller("DiagnosesListCtrl",["$scope","$stateParams","$location","$modal","Patient","Diagnosis","growlNotifications",function(a,b,c,d,e,f,g){a.patient=e.get(b.patientId),f.byPatient(a.patient.id).then(function(b){a.patient.diagnoses=b}),a.go=function(a){c.path(a)},a.selected=function(a){return a.id===b.diagnosisId},a.create=function(){var b=d.open({templateUrl:"views/diagnoses/diagnoses-modal.html",size:"lg",controller:"DiagnosesModalCtrl",resolve:{modal:function(){return{title:"Create Diagnosis"}},diagnosis:function(){return{dateOfOnset:new Date}},patient:function(){return a.patient}}});b.result.then(function(b){f.createByPatient(a.patient.id,b).then(function(b){g.add("<strong>"+a.patient.fullname()+":</strong> Diagnosis updated","success",1e4),a.patient.diagnoses.push(b.data),console.log(b)})})}}]),angular.module("openehrPocApp").controller("DiagnosesDetailCtrl",["$scope","$stateParams","$location","$modal","Patient","Diagnosis","growlNotifications",function(a,b,c,d,e,f,g){a.patient=e.get(b.patientId),f.findByPatient(a.patient.id,b.diagnosisId).then(function(b){a.diagnosis=b}),a.formDisabled=!0,a.edit=function(){var b=d.open({templateUrl:"views/diagnoses/diagnoses-modal.html",size:"lg",controller:"DiagnosesModalCtrl",resolve:{modal:function(){return{title:"Edit Diagnosis"}},diagnosis:function(){return angular.copy(a.diagnosis)},patient:function(){return a.patient}}});b.result.then(function(b){f.updateByPatient(a.patient.id,b).then(function(b){g.add("<strong>"+a.patient.fullname()+":</strong> Diagnosis updated","success",1e4),a.diagnosis=b.data})})},a.isLocked=function(a){if(!a||!a.id)return!0;var b=a.id.substring(0,1);return"P"===b||"O"===b},a.convertToLabel=function(a){var b=a.replace(/([A-Z])/g," $1");return b.charAt(0).toUpperCase()+b.slice(1)}}]),angular.module("openehrPocApp").controller("DiagnosesModalCtrl",["$scope","$modalInstance","diagnosis","patient","modal",function(a,b,c,d,e){a.diagnosis=c,a.patient=d,a.modal=e,a.ok=function(c,d){a.formSubmitted=!0,c.$valid&&b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0}}]);