"use strict";angular.module("openehrPocApp",["ngResource","ngTouch","ngSanitize","ngAnimate","ui.router","ui.bootstrap","angular-loading-bar","growlNotifications","angularUtils.directives.dirPagination"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("patients-list",{url:"/patients?ageRange&department&order&reverse",views:{actions:{templateUrl:"views/patients/patients-list-sidebar.html"},main:{templateUrl:"views/patients/patients-list.html",controller:"PatientsListCtrl"}}}).state("patients-charts",{url:"/",views:{actions:{templateUrl:"views/patients/patients-list-sidebar.html"},main:{templateUrl:"views/patients/patients-charts.html",controller:"PatientsChartsCtrl"}}}).state("diagnoses-list",{url:"/patients/:patientId/diagnoses",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/diagnoses/diagnoses-list.html",controller:"DiagnosesListCtrl"}}}).state("diagnoses-detail",{url:"/patients/:patientId/diagnoses/:diagnosisId",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/diagnoses/diagnoses-list.html",controller:"DiagnosesListCtrl"},detail:{templateUrl:"views/diagnoses/diagnoses-detail.html",controller:"DiagnosesDetailCtrl"}}})}]).config(["datepickerConfig","datepickerPopupConfig","cfpLoadingBarProvider",function(a,b,c){a.startingDay=1,b.showButtonBar=!1,b.datepickerPopup="dd-MMM-yyyy",c.includeSpinner=!1}]).config(["paginationTemplateProvider",function(a){a.setPath("views/dirPagination.tpl.html")}]),angular.module("openehrPocApp").factory("PatientService",["$http","$q","Patient",function(a,b,c){var d=function(){var d=[],e=b.defer();return a.get("/patients.json",{cache:!0}).then(function(a){angular.forEach(a.data,function(a){a=new c(a),d.push(a)}),e.resolve(d)}),e.promise},e=function(){return d()},f=function(a){var c,e=b.defer();return d().then(function(b){c=_.findWhere(b,{id:parseInt(a)}),e.resolve(c)}),e.promise},g=function(a,b){var c=_.findWhere(a.diagnoses,{id:b.id});angular.extend(c,b)},h=function(){var a=b.defer();return d().then(function(b){var c={},d=_.countBy(b,function(a){return a.ageRange});c.age=_.map(d,function(a,b){return{series:b,value:a}}),c.age=_.sortBy(c.age,function(a){return a.age});var e=_.countBy(b,function(a){return a.department});e.All=b.length,c.department=_.map(e,function(a,b){return{series:b,value:a}}),c.department=_.sortBy(c.department,function(a){return a.department}),a.resolve(c)}),a.promise};return{all:e,get:f,update:g,summaries:h}}]),angular.module("openehrPocApp").factory("Diagnosis",["$http","$q",function(a,b){var c=746,d=function(d){var e=b.defer();return a.get("/api/patients/"+(c||d)+"/diagnoses").success(function(a){e.resolve(a)}),e.promise},e=function(d,e){var f=b.defer();return a.get("/api/patients/"+(c||d)+"/diagnoses/"+e).success(function(a){f.resolve(a)}),f.promise},f=function(b,d){return a.put("/api/patients/"+(c||b)+"/diagnoses/"+d.id,d)},g=function(b,d){return d.patientId=c||b,a.post("/api/patients/"+(c||b)+"/diagnoses",d)};return{byPatient:d,findByPatient:e,updateByPatient:f,createByPatient:g}}]),angular.module("openehrPocApp").factory("Patient",["$window",function(a){var b=function(a){_.extend(this,a),this.fullname=c(this),this.address=d(this),this.age=e(this),this.ageRange=f(this)},c=function(a){return a.lastname.toUpperCase()+", "+a.firstname+(a.title?" ("+a.title+")":"")},d=function(a){return[a.address1,a.address2,a.address4].join(", ")},e=function(b){return a.moment().diff(b.born,"years")},f=function(a){var b=a.age;switch(!0){case b>=0&&10>=b:return"0-10";case b>=11&&18>=b:return"11-18";case b>=19&&30>=b:return"19-30";case b>=31&&60>=b:return"31-60";case b>=60&&80>=b:return"60-80";case b>80:return">80";default:return}};return b}]),angular.module("openehrPocApp").controller("MainCtrl",function(){}),angular.module("openehrPocApp").controller("PatientsListCtrl",["$scope","$state","$stateParams","PatientService",function(a,b,c,d){d.all().then(function(b){a.patients=b}),a.department=c.department,a.ageRange=c.ageRange,a.order=c.order||"lastname",a.reverse="true"===c.reverse,a.sort=function(c){var d=a.reverse;a.order===c&&(d=!d),b.transitionTo(b.current,{order:c,reverse:d})},a.sortClass=function(b){return a.order===b?a.reverse?"sort-desc":"sort-asc":void 0},a.go=function(a){b.go("diagnoses-list",{patientId:a.id})}}]),angular.module("openehrPocApp").controller("PatientsChartsCtrl",["$scope","$window","$state","PatientService",function(a,b,c,d){d.summaries().then(function(a){e(a),f(a)});var e=function(a){b.Morris.Bar({element:"age-chart",data:a.age,ykeys:["value"],xkey:"series",labels:["Patients"],hideHover:!0}).on("click",function(a,b){c.go("patients-list",{ageRange:b.series})})},f=function(a){b.Morris.Bar({element:"department-chart",data:a.department,ykeys:["value"],xkey:"series",labels:["Patients"],hideHover:!0,barColors:["#0BA462"]}).on("click",function(a,b){"All"===b.series&&(b.series=null),c.go("patients-list",{department:b.series})})}}]),angular.module("openehrPocApp").controller("PatientsDetailCtrl",["$scope","$stateParams","$location","PatientService",function(a,b,c,d){d.get(b.patientId).then(function(b){a.patient=b})}]),angular.module("openehrPocApp").controller("DiagnosesListCtrl",["$scope","$stateParams","$location","$modal","PatientService","Diagnosis","growlNotifications",function(a,b,c,d,e,f,g){e.get(b.patientId).then(function(b){a.patient=b,f.byPatient(a.patient.id).then(function(b){a.patient.diagnoses=b})}),a.go=function(a){c.path(a)},a.selected=function(a){return a.id===b.diagnosisId},a.create=function(){var b=d.open({templateUrl:"views/diagnoses/diagnoses-modal.html",size:"lg",controller:"DiagnosesModalCtrl",resolve:{modal:function(){return{title:"Create Diagnosis"}},diagnosis:function(){return{dateOfOnset:new Date}},patient:function(){return a.patient}}});b.result.then(function(b){f.createByPatient(a.patient.id,b).then(function(b){g.add("<strong>"+a.patient.fullname+":</strong> Diagnosis updated","success",1e4),a.patient.diagnoses.push(b.data),console.log(b)})})}}]),angular.module("openehrPocApp").controller("DiagnosesDetailCtrl",["$scope","$stateParams","$location","$modal","PatientService","Diagnosis","growlNotifications",function(a,b,c,d,e,f,g){a.UnlockedSources=["handi.ehrscape.com"],e.get(b.patientId).then(function(c){a.patient=c,f.findByPatient(a.patient.id,b.diagnosisId).then(function(b){a.diagnosis=b})}),a.formDisabled=!0,a.edit=function(){var b=d.open({templateUrl:"views/diagnoses/diagnoses-modal.html",size:"lg",controller:"DiagnosesModalCtrl",resolve:{modal:function(){return{title:"Edit Diagnosis"}},diagnosis:function(){return angular.copy(a.diagnosis)},patient:function(){return a.patient}}});b.result.then(function(b){f.updateByPatient(a.patient.id,b).then(function(b){g.add("<strong>"+a.patient.fullname+":</strong> Diagnosis updated","success",1e4),a.diagnosis=b.data,c.path("/patients/"+a.patient.id+"/diagnoses/"+a.diagnosis.id)})})},a.isLocked=function(b){if(!b||!b.id)return!0;var c=b.id.toString().split("::");return c.length>1?a.UnlockedSources.indexOf(c[1])<0:!0},a.convertToLabel=function(a){var b=a.replace(/([A-Z])/g," $1");return b.charAt(0).toUpperCase()+b.slice(1)}}]),angular.module("openehrPocApp").controller("DiagnosesModalCtrl",["$scope","$modalInstance","diagnosis","patient","modal",function(a,b,c,d,e){a.diagnosis=c,a.patient=d,a.modal=e,a.ok=function(c,d){a.formSubmitted=!0,c.$valid&&b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0}}]);